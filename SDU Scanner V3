// ==UserScript==
// @name         SDU Scanner V3
// @namespace    http://tampermonkey.net/
// @version      2
// @description  Trova la percentuale piÃ¹ alta di SDU trovate nel range di distanza dalla flotta, per funzionare bisogna avere aperta la scheda della flotta specificata
// @author       lucadjr
// @match        *://*atlas.eveeye.com/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    let currentX = 0, currentY = 0;
    let fleetName = 'My_Fleet';
    let maxDistance1 = 5;
    let maxDistance2 = 15;
    let maxDistance3 = 30;
    let selectedColor = 'yellow';

    function makeDraggable(el) {
        el.style.position = 'absolute';
        el.style.cursor = 'move';
        let offsetX = 0, offsetY = 0, mouseX = 0, mouseY = 0;

        const onMouseMove = (e) => {
            e.preventDefault();
            offsetX = mouseX - e.clientX;
            offsetY = mouseY - e.clientY;
            mouseX = e.clientX;
            mouseY = e.clientY;
            el.style.top = (el.offsetTop - offsetY) + "px";
            el.style.left = (el.offsetLeft - offsetX) + "px";
        };

        const onMouseDown = (e) => {
            if (['input', 'textarea', 'button', 'table', 'label', 'select'].includes(e.target.tagName.toLowerCase())) {
                return;
            }
            e.preventDefault();
            mouseX = e.clientX;
            mouseY = e.clientY;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        };

        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };

        el.addEventListener('mousedown', onMouseDown);
    }

    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.top = '10px';
    container.style.right = '10px';
    container.style.zIndex = 1000;
    container.style.padding = '10px';
    container.style.backgroundColor = '#f9f9f9';
    container.style.border = '1px solid #ccc';
    container.style.borderRadius = '5px';
    container.style.width = '400px';
    container.style.maxHeight = '700px';
    document.body.appendChild(container);
    makeDraggable(container);


    const closeButton = document.createElement('button');
    closeButton.textContent = 'X';
    closeButton.style.position = 'absolute';
    closeButton.style.top = '5px';
    closeButton.style.right = '5px';
    closeButton.style.backgroundColor = 'red';
    closeButton.style.color = 'white';
    closeButton.style.border = 'none';
    closeButton.style.borderRadius = '50%';
    closeButton.style.width = '25px';
    closeButton.style.height = '25px';
    closeButton.style.cursor = 'pointer';

    closeButton.onclick = function() {
        container.remove(); // Rimuove il div dal DOM
    };

    container.appendChild(closeButton);

    const headerContainer = document.createElement('div');
    headerContainer.style.marginBottom = '10px';
    container.appendChild(headerContainer);

    // Aggiungere l'icona (puoi usare un'icona font o un'immagine)
    const icon = document.createElement('img');
    icon.src = 'https://play.staratlas.com/icon-small.png'; // Usa il tuo URL o icona
    icon.alt = 'Icona';
    icon.style.marginRight = '10px'; // Distanza tra icona e testo
    headerContainer.appendChild(icon);

    // Aggiungere il titolo
    const title = document.createElement('span');
    title.textContent = 'SDU Scanner V2 by lucadjr';
    title.style.fontSize = '20px';
    title.style.fontWeight = 'bold';
    headerContainer.appendChild(title);


    const currentPosition = document.createElement('div');
    currentPosition.textContent = 'Posizione attuale: N/A';
    currentPosition.style.marginBottom = '10px';
    container.appendChild(currentPosition);

    const inputContainer = document.createElement('div');
    inputContainer.style.display = 'flex';
    inputContainer.style.marginBottom = '10px';
    container.appendChild(inputContainer);

    const fleetInputContainer = document.createElement('div');
    fleetInputContainer.style.display = 'flex';
    fleetInputContainer.style.flexDirection = 'column'; // Cambia l'orientamento a verticale
    fleetInputContainer.style.marginBottom = '10px';
    inputContainer.appendChild(fleetInputContainer);

        const fleetInputLabel = document.createElement('label');
        fleetInputLabel.textContent = 'Nome Flotta: ';
        fleetInputLabel.style.marginBottom = '5px'; // Spazio sotto l'etichetta
        fleetInputContainer.appendChild(fleetInputLabel);

        const fleetInput = document.createElement('input');
        fleetInput.type = 'text';
        fleetInput.value = fleetName;
        fleetInput.size = '15'
        fleetInput.style.padding = '5px';
        fleetInput.style.boxSizing = 'border-box';
        fleetInput.addEventListener('input', (e) => {
            fleetName = e.target.value;
        });
        fleetInputContainer.appendChild(fleetInput);

        const ocrcheckContainer = document.createElement('div');
        ocrcheckContainer.style.display = 'flex';
        ocrcheckContainer.style.margin = '1px';
        fleetInputContainer.appendChild(ocrcheckContainer);

            const ocrLabel = document.createElement('label');
            ocrLabel.textContent = 'Ocr facilitator ';
            ocrcheckContainer.appendChild(ocrLabel);        

            const ocrcheckbox = document.createElement('input');
            ocrcheckbox.type = 'checkbox';
            ocrcheckbox.name = 'ocrenable';
            ocrcheckbox.checked = false;
            ocrcheckbox.addEventListener('change', function () {
                if (ocrcheckbox.checked) {
                    ocrsizeContainer.style.visibility = 'visible';
                    colorSelect.style.display = 'block';
                } else {
                    ocrsizeContainer.style.visibility = 'hidden';
                    colorSelect.style.display = 'none'; // Inizialmente nascosto
                    ocrUpdatesize(14);
                    selectedColor = 'yellow';
                    ocrUpdatecolor(selectedColor);
                }
            });
            ocrcheckContainer.appendChild(ocrcheckbox);

        const ocrsizeContainer = document.createElement('div');
        ocrsizeContainer.style.visibility = 'hidden';
        ocrsizeContainer.style.display = 'center';
        ocrsizeContainer.style.margin = '1px';
        fleetInputContainer.appendChild(ocrsizeContainer);    

            const percsizeLabel = document.createElement('label');
            percsizeLabel.textContent = 'Size ';
            ocrsizeContainer.appendChild(percsizeLabel); 
            
            const percsizeInput = document.createElement('input');
            percsizeInput.type = 'number';
            percsizeInput.min = '1';
            percsizeInput.max = '99'; // Limita il numero massimo a 99
            percsizeInput.value = '14';
            percsizeInput.size = '6'; // Limita l'input a due cifre
            percsizeInput.style.padding = '5px';
            percsizeInput.style.boxSizing = 'border-box';
            percsizeInput.addEventListener('input', (e) => {
                let orcsize = 0;
                orcsize = e.target.value ? parseInt(e.target.value, 10) : Infinity;
                ocrUpdatesize(orcsize);
            });
            ocrsizeContainer.appendChild(percsizeInput);

            const percsizeLabel2 = document.createElement('label');
            percsizeLabel2.textContent = 'px';
            ocrsizeContainer.appendChild(percsizeLabel2); 
        
        // Creazione del menu a tendina (select)
        const colorSelect = document.createElement('select');
        colorSelect.style.display = 'none';
        const colors = ['yellow', 'red', 'green', 'blue', 'pink', 'orange'];
        colors.forEach(color => {
            const option = document.createElement('option');
            option.value = color;
            option.textContent = color;
            colorSelect.appendChild(option);
        });
        colorSelect.addEventListener('change', function () {
            selectedColor = colorSelect.value; // Colore selezionato
            ocrUpdatecolor(selectedColor);
        });
        fleetInputContainer.appendChild(colorSelect);    

    const ResultContainer = document.createElement('div');
    ResultContainer.style.display = 'flex';
    ResultContainer.style.marginLeft = '10px';
    inputContainer.appendChild(ResultContainer);

        const distanceInputContainer = document.createElement('div');
        distanceInputContainer.style.display = 'flex';
        distanceInputContainer.style.flexDirection = 'column'; // Cambia l'orientamento a verticale
        distanceInputContainer.style.marginLeft = '10px'; // Spazio sopra l'etichetta
        distanceInputContainer.style.marginBottom = '10px';
        ResultContainer.appendChild(distanceInputContainer);

            const distanceInputLabel = document.createElement('label');
            distanceInputLabel.textContent = 'Distanza Max: ';
            distanceInputLabel.style.marginBottom = '5px'; // Spazio sotto l'etichetta
            distanceInputContainer.appendChild(distanceInputLabel);

            const distanceInput1 = document.createElement('input');
            distanceInput1.type = 'number';
            distanceInput1.min = '1';
            distanceInput1.max = '99'; // Limita il numero massimo a 99
            distanceInput1.value = '5';
            distanceInput1.size = '6'; // Limita l'input a due cifre
            distanceInput1.style.padding = '5px';
            distanceInput1.style.boxSizing = 'border-box';
            distanceInput1.addEventListener('input', (e) => {
                maxDistance1 = e.target.value ? parseInt(e.target.value, 10) : Infinity;
                updateTable(currentData);
            });
            distanceInputContainer.appendChild(distanceInput1);

            const distanceInput2 = document.createElement('input');
            distanceInput2.type = 'number';
            distanceInput2.min = '1';
            distanceInput2.max = '99'; // Limita il numero massimo a 99
            distanceInput2.value = '15';
            distanceInput2.size = '6'; // Limita l'input a due cifre
            distanceInput2.style.padding = '5px';
            distanceInput2.style.boxSizing = 'border-box';
            distanceInput2.addEventListener('input', (e) => {
                maxDistance2 = e.target.value ? parseInt(e.target.value, 10) : Infinity;
                updateTable(currentData);
            });
            distanceInputContainer.appendChild(distanceInput2);

            const distanceInput3 = document.createElement('input');
            distanceInput3.type = 'number';
            distanceInput3.min = '1';
            distanceInput3.max = '99'; // Limita il numero massimo a 99
            distanceInput3.value = '30';
            distanceInput3.size = '6'; // Limita l'input a due cifre
            distanceInput3.style.padding = '5px';
            distanceInput3.style.boxSizing = 'border-box';
            distanceInput3.addEventListener('input', (e) => {
                maxDistance3 = e.target.value ? parseInt(e.target.value, 10) : Infinity;
                updateTable(currentData);  
            });
            distanceInputContainer.appendChild(distanceInput3);

        const percLabelContainer = document.createElement('div');
        percLabelContainer.style.display = 'flex';
        percLabelContainer.style.flexDirection = 'column'; // Cambia l'orientamento a verticale
        percLabelContainer.style.marginLeft = '10px'; // Spazio sopra l'etichetta
        percLabelContainer.style.marginBottom = '10px';
        ResultContainer.appendChild(percLabelContainer);

            const percResultLabel = document.createElement('label');
            percResultLabel.textContent = '%';
            percResultLabel.style.marginBottom = '5px'; // Spazio sotto l'etichetta
            percLabelContainer.appendChild(percResultLabel);

            const percentualeLabel1 = document.createElement('label');
            percentualeLabel1.textContent = '-';
            percentualeLabel1.style.fontSize = '14px'; // Modifica la dimensione del font
            percentualeLabel1.style.backgroundColor = 'yellow'; // Colore di sfondo giallo
            percentualeLabel1.style.fontWeight = 'bold'; // Testo in grassetto
            percentualeLabel1.style.margin = '6px';
            percLabelContainer.appendChild(percentualeLabel1);

            const percentualeLabel2 = document.createElement('label');
            percentualeLabel2.textContent = '-';
            percentualeLabel2.style.fontSize = '14px'; // Modifica la dimensione del font
            percentualeLabel2.style.backgroundColor = 'yellow'; // Colore di sfondo giallo
            percentualeLabel2.style.fontWeight = 'bold'; // Testo in grassetto
            percentualeLabel2.style.margin = '6px';
            percLabelContainer.appendChild(percentualeLabel2);

            const percentualeLabel3 = document.createElement('label');
            percentualeLabel3.textContent = '-';
            percentualeLabel3.style.fontSize = '14px'; // Modifica la dimensione del font
            percentualeLabel3.style.backgroundColor = 'yellow'; // Colore di sfondo giallo
            percentualeLabel3.style.fontWeight = 'bold'; // Testo in grassetto
            percentualeLabel3.style.margin = '6px';
            percLabelContainer.appendChild(percentualeLabel3);

        const percCoordContainer = document.createElement('div');
        percCoordContainer.style.display = 'flex';
        percCoordContainer.style.flexDirection = 'column'; // Cambia l'orientamento a verticale
        percCoordContainer.style.marginLeft = '10px'; // Spazio sopra l'etichetta
        percCoordContainer.style.marginBottom = '10px';
        ResultContainer.appendChild(percCoordContainer);

            const coordResultLabel = document.createElement('label');
            coordResultLabel.textContent = 'Coords';
            coordResultLabel.style.marginBottom = '5px'; // Spazio sotto l'etichetta
            percCoordContainer.appendChild(coordResultLabel);

            const percCoordTxt1 = document.createElement('input');
            percCoordTxt1.type = 'text';
            percCoordTxt1.name = 'percCoordTxt1';
            percCoordTxt1.size = '5';
            percCoordTxt1.style.margin = '4px';
            percCoordTxt1.style.width = '50px'; // Imposta una larghezza specifica in pixel
            percCoordContainer.appendChild(percCoordTxt1);

            const percCoordTxt2 = document.createElement('input');
            percCoordTxt2.type = 'text';
            percCoordTxt2.name = 'percCoordTxt2';
            percCoordTxt2.size = '5';
            percCoordTxt2.style.margin = '4px';
            percCoordTxt2.style.width = '50px'; // Imposta una larghezza specifica in pixel
            percCoordContainer.appendChild(percCoordTxt2);

            const percCoordTxt3 = document.createElement('input');
            percCoordTxt3.type = 'text';
            percCoordTxt3.name = 'percCoordTxt3';
            percCoordTxt3.size = '5';
            percCoordTxt3.style.margin = '4px';
            percCoordTxt3.style.width = '50px'; // Imposta una larghezza specifica in pixel
            percCoordContainer.appendChild(percCoordTxt3);


    const sortContainer = document.createElement('div');
    sortContainer.style.display = 'flex';
    sortContainer.style.flexDirection = 'column';
    sortContainer.style.marginLeft = '10px';
    inputContainer.appendChild(sortContainer);

    const probContainer = document.createElement('div');
    probContainer.style.display = 'flex';
    probContainer.style.marginLeft = '10px';
    sortContainer.appendChild(probContainer);

    const sortProbLabel = document.createElement('label');
    sortProbLabel.textContent = 'Ordina per %';
    probContainer.appendChild(sortProbLabel);

    const sortProbRadio = document.createElement('input');
    sortProbRadio.type = 'radio';
    sortProbRadio.name = 'sortOption';
    sortProbRadio.value = 'prob';
    sortProbRadio.checked = true;
    probContainer.appendChild(sortProbRadio);

    const DistanceContainer = document.createElement('div');
    DistanceContainer.style.display = 'flex';
    DistanceContainer.style.marginLeft = '10px';
    sortContainer.appendChild(DistanceContainer);

    const sortDistanceLabel = document.createElement('label');
    sortDistanceLabel.textContent = 'Ordina per Distanza';
    DistanceContainer.appendChild(sortDistanceLabel);

    const sortDistanceRadio = document.createElement('input');
    sortDistanceRadio.type = 'radio';
    sortDistanceRadio.name = 'sortOption';
    sortDistanceRadio.value = 'distance';
    DistanceContainer.appendChild(sortDistanceRadio);

    const button = document.createElement('button');
    button.textContent = 'Avvia Scansione Automatica';
    button.style.flex = '1';
    button.style.padding = '10px';
    button.style.backgroundColor = '#007BFF';
    button.style.color = '#fff';
    button.style.border = 'none';
    button.style.borderRadius = '5px';
    button.style.cursor = 'pointer';
    container.appendChild(button);

    const tablecontainer = document.createElement('div');
    tablecontainer.style.maxHeight = '300px';
    tablecontainer.style.overflowY = 'auto';
    container.appendChild(tablecontainer);

    const table = document.createElement('table');
    table.style.width = '100%';
    table.style.borderCollapse = 'collapse';
    table.style.marginTop = '10px';
    table.style.marginBottom = '10px';
    tablecontainer.appendChild(table);

    const headerRow = document.createElement('tr');
    headerRow.innerHTML = '<th style="border-bottom: 1px solid #ccc;">Prob (%)</th><th style="border-bottom: 1px solid #ccc;">Coordinate (X,Y)</th><th style="border-bottom: 1px solid #ccc;">Distanza</th>';
    table.appendChild(headerRow);

    const byebyecontainer = document.createElement('div');
    byebyecontainer.style.border = 'solid';
    byebyecontainer.style.borderColor = 'gray';
    container.appendChild(byebyecontainer);

    const byebye = document.createElement('label');
    byebye.textContent = 'Report bugs, improvements or comment at lucadjr@hotmail.it                        if you like the app please donate 7sZFMdaGCATXsJuWfj19ExnLt9P7RVm4Bykmvz2Jrh5x';
    byebye.style.userSelect = 'text';
    byebyecontainer.appendChild(byebye);


    button.addEventListener('click', toggleScan);

    let intervalId = null;
    let currentData = [];

    function toggleScan() {
        if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
            button.textContent = 'Avvia Scansione Automatica';
        } else {
            scanData();
            intervalId = setInterval(scanData, 2000);
            button.textContent = 'Arresta Scansione Automatica';
        }
    }

    function scanData() {
        updateFleetPosition();
        const elements = document.querySelectorAll('.sector_sdu_txt');
        const data = [];

        elements.forEach(el => {
            const prob = el.textContent.trim();

            // Filtra gli elementi con prob validi (non 0% e non vuoti)
            if (prob !== '0%' && prob !== '') {
                const idParts = el.id.split('_');
                const x = parseFloat(idParts[idParts.length - 2]);
                const y = parseFloat(idParts[idParts.length - 1]);
                const distance = calculateDistance(currentX, currentY, x, y);
                data.push({ prob, x, y, distance });
            }
        });

        currentData = data;
        table.innerHTML = '<tr><th style="border-bottom: 1px solid #ccc;">Prob (%)</th><th style="border-bottom: 1px solid #ccc;">Coordinate (X,Y)</th><th style="border-bottom: 1px solid #ccc;">Distanza</th></tr>';
        if (sortProbRadio.checked) {
            currentData.sort((a, b) => parseFloat(b.prob) - parseFloat(a.prob));
            updateTable(currentData);
        } else {
            currentData.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
            updateTable(currentData);
        }
    }

    function trovapercentuale(data, maxDistance, percentualeLabel, percCoordTxt) {
        let maxProbInRange = -1;
        let closestToMaxProb = null;

        // Prima, troviamo la probabilitÃ  massima nel range
        data.forEach(item => {
            if (item.distance <= maxDistance) {
                if (parseFloat(item.prob) > maxProbInRange) {
                    maxProbInRange = parseFloat(item.prob);
                }
            }
        });

        // Ora, tra le righe con la probabilitÃ  massima, troviamo la piÃ¹ vicina
        let minDistance = Infinity;
        data.forEach(item => {
            if (item.distance <= maxDistance && parseFloat(item.prob) === maxProbInRange) {
                if (item.distance < minDistance) {
                    minDistance = item.distance;
                    closestToMaxProb = item; // Memorizziamo la riga con la probabilitÃ  massima e la distanza minima
                    percentualeLabel.textContent = item.prob;
                    percCoordTxt.value = item.x + ',' + item.y; // Aggiorniamo il campo di input con le coordinate
                }
            }
        });
        return closestToMaxProb;
    }

    function updateTable(data) {

        let closestToMaxProb1 = trovapercentuale(data, maxDistance1, percentualeLabel1, percCoordTxt1);
        let closestToMaxProb2 = trovapercentuale(data, maxDistance2, percentualeLabel2, percCoordTxt2);
        let closestToMaxProb3 = trovapercentuale(data, maxDistance3, percentualeLabel3, percCoordTxt3);

        // Creiamo la tabella e evidenziamo la riga piÃ¹ vicina
        data.slice(0, 500).forEach(item => {

            const row = document.createElement('tr');
            row.innerHTML = `<td style="border-bottom: 1px solid #ccc; text-align: center;">${item.prob}</td>
                     <td style="border-bottom: 1px solid #ccc; text-align: center;">${item.x},${item.y}</td>
                     <td style="border-bottom: 1px solid #ccc; text-align: center;">${item.distance}</td>`;

            if (item === closestToMaxProb1 || item === closestToMaxProb2 || item === closestToMaxProb3) {
                row.style.backgroundColor = selectedColor; // Evidenziamo solo la riga piÃ¹ vicina
            }
            table.appendChild(row);
        });

    }

    function calculateDistance(x1, y1, x2, y2) {
        return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)).toFixed(2);
    }

    function updateFleetPosition() {
        const fleetRow = document.querySelector(`#fleetStats .ui_fleet span[oncontextmenu*="${fleetName}"]`);
        if (fleetRow) {
            const stateRow = fleetRow.closest('tr').nextElementSibling;
            const tdElement = stateRow.querySelector('#fleet_selected_state');
            if (tdElement) {
                // Estrai tutte le coordinate presenti nel td
                const coordElements = tdElement.querySelectorAll('.ui_coordinate');
                if (coordElements.length > 0) {
                    // Mappa tutte le coordinate in formato [X, Y]
                    const allCoords = Array.from(coordElements).map(coordElement =>
                        coordElement.textContent.trim().replace('|', ',')
                    );

                    // Prendi l'ultima serie di coordinate
                    const finalCoords = allCoords[allCoords.length - 1];
                    [currentX, currentY] = finalCoords.split(',').map(coord => parseFloat(coord.trim()));

                    // Aggiorna il textContent con un messaggio flessibile
                    const scenarioDescription = tdElement.textContent
                        .replace(/\s+/g, ' ') // Rimuove spazi multipli
                        .trim();
                    currentPosition.textContent = `${scenarioDescription.replace('|', ',')}`;
                } else {
                    // Nessuna coordinata trovata
                    currentPosition.textContent = 'Posizione attuale: N/A';
                }
            } else {
                currentPosition.textContent = 'Posizione attuale: N/A';
            }
        } else {
            currentPosition.textContent = 'Posizione attuale: N/A';
        }
    }

    function ocrUpdatesize(size){
            let sizestr = String(size) + 'px';
            percentualeLabel1.style.fontSize = sizestr; // Modifica la dimensione del font
            percentualeLabel2.style.fontSize = sizestr; // Modifica la dimensione del font
            percentualeLabel3.style.fontSize = sizestr; // Modifica la dimensione del font
            percCoordTxt1.style.fontSize = sizestr; // Modifica la dimensione del font
            percCoordTxt2.style.fontSize = sizestr; // Modifica la dimensione del font 
            percCoordTxt3.style.fontSize = sizestr; // Modifica la dimensione del font
            let sizeelement = String(50 + 3 * (size - 13)) + 'px';
            percCoordTxt1.style.width = sizeelement;
            percCoordTxt2.style.width = sizeelement;
            percCoordTxt3.style.width = sizeelement;                       
    }

    function ocrUpdatecolor(color){
        percentualeLabel1.style.backgroundColor = color; // Colore di sfondo giallo
        percentualeLabel2.style.backgroundColor = color; // Colore di sfondo giallo
        percentualeLabel3.style.backgroundColor = color; // Colore di sfondo giallo
    }

})();
